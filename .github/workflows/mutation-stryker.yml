name: CI (mutation-stryker)

on:
  push:
    branches: ["main", "master"]
  pull_request:

jobs:
  mutation:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET (from global.json)
        uses: actions/setup-dotnet@v4
        with:
          global-json-file: global.json

      - name: Restore
        run: dotnet restore

      - name: Build
        run: dotnet build -c Release --no-restore

      # FIX: Ensure the solution file exists (Stryker config references FitnessBooking.sln)
      - name: Ensure FitnessBooking.sln exists for Stryker
        shell: bash
        run: |
          if [ ! -f "FitnessBooking.sln" ]; then
            echo "FitnessBooking.sln not found. Creating one for CI..."
            dotnet new sln -n FitnessBooking

            # Add projects that exist (safe for CI even if structure changes slightly)
            for p in \
              src/FitnessBooking.Domain/FitnessBooking.Domain.csproj \
              src/FitnessBooking.Application/FitnessBooking.Application.csproj \
              src/FitnessBooking.Infrastructure/FitnessBooking.Infrastructure.csproj \
              src/FitnessBooking.Api/FitnessBooking.Api.csproj \
              tests/FitnessBooking.UnitTests/FitnessBooking.UnitTests.csproj \
              tests/FitnessBooking.IntegrationTests/FitnessBooking.IntegrationTests.csproj \
              tests/FitnessBooking.PropertyTests/FitnessBooking.PropertyTests.csproj
            do
              if [ -f "$p" ]; then
                dotnet sln FitnessBooking.sln add "$p"
              else
                echo "Skipping missing project: $p"
              fi
            done
          else
            echo "FitnessBooking.sln already exists."
          fi

      - name: Install Stryker.NET
        shell: bash
        run: |
          dotnet tool install -g dotnet-stryker || dotnet tool update -g dotnet-stryker
          echo "$HOME/.dotnet/tools" >> $GITHUB_PATH

      - name: Run Stryker (UnitTests)
        run: dotnet stryker --config-file stryker-config.json --log-to-file

      - name: Upload Stryker report (always)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: stryker-report
          path: |
            **/StrykerOutput/**
            **/stryker.log
